{% import _self as self %}

{% macro css_properties(props) %}
  {% set layout = props.layout %}
  {% set flex_child = props.flex_child %}
  {% set grid_child = props.grid_child %}
  {% set position = props.position %}
  {% set size = props.size %}
  {% set typography = props.typography %}
  {% set background = props.background %}
  {% set borders = props.borders %}
  {% set effects = props.effects %}
  {% set custom_css = props.custom_css %}
  {% set margin = props.spacing.spacing.margin %}
  {% set padding = props.spacing.spacing.padding %}

  /* Box-model */
  display: {{ layout.display }};

  /* Flex */
  flex-flow: {{ layout.flex_direction }};
  justify-content: {{ layout.flex_align.primary_axis }};
  align-items: {{ layout.flex_align.cross_axis }};

  /* Grid */
  {% if layout.grid.enable_advanced_mode %}
    grid-template-columns: {% for c in layout.grid_template_columns %}
      {{ c.size.style }}{% if not loop.last %} {% endif %}
    {% endfor %};

    grid-template-rows: {% for row in layout.grid_template_rows %}
      {{ row.size.style }}{% if not loop.last %} {% endif %}
    {% endfor %};

    grid-template-areas: {% for area in layout.grid_area %}
      "{{ area.name }}"{% if not loop.last %} {% endif %}
    {% endfor %};

    grid-auto-columns: {{ layout.grid_auto_columns.style }};
    grid-auto-rows: {{ layout.grid_auto_rows.style }};
  {% else %}
    {% if layout.grid.simple_grid_template_columns %}
      grid-template-columns: repeat({{ layout.grid.simple_grid_template_columns }}, 1fr);
    {% endif %}

    {% if layout.grid.simple_grid_template_rows %}
      grid-template-rows: repeat({{ layout.grid.simple_grid_template_rows }}, auto);
    {% endif %}
  {% endif %}

  grid-auto-flow: {{ layout.grid_auto_flow }};

  align-items: {{ layout.grid_align.primary_axis }};
  justify-items: {{ layout.grid_align.cross_axis }};

  justify-content: {{ layout.grid_justify_content }};
  align-content: {{ layout.grid_align_content }};

  gap: {{ layout.gap.row.style == layout.gap.column.style ? layout.gap.row.style : layout.gap.row.style ~ ' ' ~ layout.gap.column.style }};

  /* Flex Child */
  flex-grow: {{ flex_child.flex_grow }};
  flex-shrink: {{ flex_child.flex_shrink }};
  flex-basis: {{ flex_child.flex_basis.style }};
  align-self: {{ flex_child.align_self }};

  {% if flex_child.order == 'custom' %}
    order: {{ flex_child.order_custom }};
  {% else %}
    order: {{ flex_child.order }};
  {% endif %}

  /* Grid Child */
  align-self: {{ grid_child.align_self }};
  justify-self: {{ grid_child.justify_self }};

  grid-row-start: {{ grid_child.row_start }};
  grid-row-end: {{ grid_child.row_end }};

  grid-column-start: {{ grid_child.column_start }};
  grid-column-end: {{ grid_child.column_end }};

  grid-area: {{ grid_child.area }};

  {% if grid_child.order == 'custom' %}
    order: {{ grid_child.order_custom }};
  {% else %}
    order: {{ grid_child.order }};
  {% endif %}

  /* Positioning */
  position: {{ position.position }};
  top: {{ position.top.style }};
  right: {{ position.right.style }};
  bottom: {{ position.bottom.style }};
  left: {{ position.left.style }};
  z-index: {{ position.z_index }};

  /* Sizing */
  width: {{ size.width.style }};
  height: {{ size.height.style }};
  max-width: {{ size.max_width.style }};
  max-height: {{ size.max_height.style }};
  min-width: {{ size.min_width.style }};
  min-height: {{ size.min_height.style }};
  overflow: {{ size.overflow }};

  object-fit: {{ size.object_fit }};
  object-position: {{ size.object_position.x.style }} {{ size.object_position.y.style }};

  box-sizing: {{ size.box_sizing }};

  {% if size.aspect_ratio == 'custom' %}
    {% if size.aspect_ratio_custom.width and not size.aspect_ratio_custom.height %}
      aspect-ratio: {{ size.aspect_ratio_custom.width }};
    {% else %}
      aspect-ratio: {{ size.aspect_ratio_custom.width }} / {{ size.aspect_ratio_custom.height }};
    {% endif %}
  {% else %}
    aspect-ratio: {{ size.aspect_ratio }};
  {% endif %}

  /* Typography */
  color: {{ typography.color }};
  font-family: {{ process_font(typography.font_family) }};
  font-weight: {{ typography.font_weight }};
  font-size: {{ typography.font_size.style }};
  line-height: {{ typography.line_height.style }};
  text-align: {{ typography.text_align }};
  text-decoration: {{ typography.style.text_decoration }};
  font-style: {{ typography.style.font_style }};
  text-transform: {{ typography.text_transform }};
  letter-spacing: {{ typography.letter_spacing.style }};
  direction: {{ typography.direction }};
  text-indent: {{ typography.text_indent.style }};
  text-overflow: {{ typography.text_overflow }};
  list-style-type: {{ typography.list_style }};

  overflow-wrap: {{ typography.overflow_wrap }};
  text-wrap: {{ typography.text_wrap }};

  -webkit-text-stroke: {{ typography.stroke.stroke_width.style }} {{ typography.stroke.stroke_color }};

  {% set textShadow = '' %}
  {% for shadow in typography.text_shadow %}
    {% if not shadow.disabled %}
      {% set textShadow = textShadow ~ shadow.x.style ~ ' ' ~ shadow.y.style ~ ' ' ~ shadow.blur.style ~ ' ' ~ shadow.color %}
      {% if not loop.last %}
          {% set textShadow = textShadow ~ ', ' %}
      {% endif %}
    {% endif %}
  {% endfor %}
  text-shadow: {{ textShadow }};

  /* Spacing */

  margin-top: {{ margin.top.style }};
  margin-right: {{ margin.right.style }};
  margin-bottom: {{ margin.bottom.style }};
  margin-left: {{ margin.left.style }};

  padding-top: {{ padding.top.style }};
  padding-right: {{ padding.right.style }};
  padding-bottom: {{ padding.bottom.style }};
  padding-left: {{ padding.left.style }};

  /* Background */
  background-color: {{ background.background_color }};

  {% set bg_image = [] %}
  {% set bg_size = [] %}
  {% set bg_position = [] %}
  {% set bg_repeat = [] %}
  {% set bg_attachment = [] %}
  {% set bg_image_placeholder = "data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22140%22%20height%3D%22140%22%20viewBox%3D%220%200%20140%20140%22%20fill%3D%22none%22%3E%3Cpath%20fill%3D%22%23E0E0E0%22%20d%3D%22M0%200h140v140H0z%22%2F%3E%3Cpath%20fill%3D%22%23C2C2C2%22%20d%3D%22M25.868%2067v-8.727h3.494c.642%200%201.178.095%201.607.285.429.19.751.455.967.793.216.335.324.721.324%201.159%200%20.34-.068.64-.205.9a1.766%201.766%200%200%201-.562.63%202.305%202.305%200%200%201-.81.345v.085a1.991%201.991%200%200%201%201.645%201.01c.182.31.273.68.273%201.108%200%20.463-.115.877-.345%201.24-.228.36-.564.646-1.01.857-.446.21-.996.315-1.65.315h-3.728Zm1.845-1.508h1.504c.515%200%20.89-.099%201.125-.295a.985.985%200%200%200%20.354-.792c0-.242-.058-.455-.175-.64a1.187%201.187%200%200%200-.498-.434%201.708%201.708%200%200%200-.763-.158h-1.547v2.319Zm0-3.567h1.368c.253%200%20.477-.044.673-.132a1.12%201.12%200%200%200%20.469-.384%201%201%200%200%200%20.175-.592.957.957%200%200%200-.337-.763c-.221-.193-.537-.29-.946-.29h-1.402v2.16ZM35.306%2067h-1.977l3.012-8.727h2.378L41.728%2067H39.75l-2.186-6.733h-.068L35.306%2067Zm-.124-3.43h4.67v1.44h-4.67v-1.44Zm14.886-2.242h-1.866a1.825%201.825%200%200%200-.21-.643%201.637%201.637%200%200%200-.404-.486%201.781%201.781%200%200%200-.571-.307%202.184%202.184%200%200%200-.695-.107c-.451%200-.845.113-1.18.337-.335.222-.595.546-.78.972-.184.423-.277.937-.277%201.542%200%20.622.093%201.145.277%201.568.188.424.45.743.784.96a2.1%202.1%200%200%200%201.164.323c.247%200%20.475-.032.686-.098a1.645%201.645%200%200%200%20.976-.75c.11-.182.187-.389.23-.622l1.866.009a3.487%203.487%200%200%201-1.133%202.152c-.321.29-.705.52-1.15.69a4.23%204.23%200%200%201-1.505.251c-.779%200-1.475-.176-2.088-.528-.611-.352-1.094-.862-1.45-1.53-.351-.668-.527-1.476-.527-2.425%200-.951.178-1.761.536-2.429.358-.667.844-1.176%201.458-1.525.613-.352%201.304-.529%202.07-.529.506%200%20.975.071%201.407.214.435.142.82.349%201.155.622.335.27.608.6.818.992.213.393.35.841.41%201.347ZM51.391%2067v-8.727h1.846v3.848h.115l3.14-3.848h2.212l-3.239%203.907L58.742%2067h-2.207l-2.39-3.588-.909%201.108V67h-1.845Zm13.569-5.906a1.91%201.91%200%200%200-.252-.55%201.702%201.702%200%200%200-.925-.669%202.232%202.232%200%200%200-.652-.09c-.446%200-.838.111-1.176.333-.335.221-.596.544-.784.967-.187.42-.281.935-.281%201.543%200%20.608.092%201.125.277%201.551.185.426.446.751.784.976.338.221.737.332%201.197.332.418%200%20.775-.074%201.07-.221.298-.15.526-.363.682-.635.159-.273.238-.596.238-.968l.375.056h-2.25v-1.39h3.652v1.1c0%20.767-.161%201.426-.485%201.977-.324.548-.77.972-1.338%201.27-.569.296-1.22.443-1.952.443-.818%200-1.537-.18-2.156-.54a3.755%203.755%200%200%201-1.45-1.548c-.343-.67-.515-1.466-.515-2.386%200-.708.102-1.338.307-1.892a4.043%204.043%200%200%201%20.87-1.415c.372-.386.805-.68%201.299-.882a4.212%204.212%200%200%201%201.607-.303c.494%200%20.954.073%201.38.218.426.142.804.343%201.134.605.332.261.603.572.814.933.21.358.345.753.404%201.185H64.96ZM68.302%2067v-8.727h3.443c.659%200%201.221.118%201.687.353a2.45%202.45%200%200%201%201.07.993c.247.426.37.928.37%201.505%200%20.58-.124%201.078-.374%201.495-.25.415-.613.733-1.087.955-.472.221-1.043.332-1.713.332h-2.306v-1.483H71.4c.352%200%20.644-.048.877-.145.233-.096.407-.241.52-.434.117-.193.175-.434.175-.72%200-.29-.058-.535-.175-.733a1.071%201.071%200%200%200-.524-.452c-.233-.105-.527-.158-.882-.158h-1.244V67H68.3Zm4.713-3.972L75.184%2067h-2.037l-2.123-3.972h1.99Zm11.181-.392c0%20.952-.18%201.762-.54%202.43a3.753%203.753%200%200%201-1.467%201.53c-.616.349-1.31.523-2.08.523-.775%200-1.47-.176-2.087-.528-.617-.352-1.104-.862-1.462-1.53-.358-.668-.537-1.476-.537-2.425%200-.951.18-1.761.537-2.429.358-.667.845-1.176%201.462-1.525.616-.352%201.312-.529%202.088-.529.77%200%201.463.177%202.08.529.619.35%201.107.858%201.465%201.525.361.668.541%201.478.541%202.43Zm-1.87%200c0-.616-.093-1.136-.277-1.56-.182-.423-.44-.744-.772-.962a2.075%202.075%200%200%200-1.167-.328c-.446%200-.835.109-1.168.328-.332.218-.59.54-.775.963-.182.423-.273.943-.273%201.56%200%20.616.09%201.136.272%201.559.185.423.444.744.776.963.333.219.722.328%201.168.328.446%200%20.835-.11%201.167-.328.333-.219.59-.54.772-.963.184-.423.277-.943.277-1.56Zm8.628-4.363h1.845v5.667c0%20.637-.152%201.194-.456%201.67a3.05%203.05%200%200%201-1.266%201.117c-.542.264-1.174.397-1.896.397-.724%200-1.358-.132-1.9-.397a3.05%203.05%200%200%201-1.266-1.116c-.301-.478-.452-1.034-.452-1.67v-5.668h1.845v5.51c0%20.332.073.627.218.886.147.259.355.462.622.61.267.147.578.221.933.221.358%200%20.67-.074.933-.222.267-.147.473-.35.618-.609.148-.258.222-.554.222-.886v-5.51Zm10.663%200V67h-1.594l-3.797-5.493h-.064V67h-1.845v-8.727h1.62l3.767%205.488h.076v-5.488h1.837ZM106.235%2067h-3.094v-8.727h3.12c.877%200%201.633.174%202.267.524.633.347%201.12.845%201.461%201.496.344.65.516%201.429.516%202.335%200%20.909-.172%201.69-.516%202.344a3.545%203.545%200%200%201-1.47%201.504c-.636.35-1.398.524-2.284.524Zm-1.248-1.581h1.171c.546%200%201.005-.097%201.377-.29.375-.196.656-.498.844-.907.19-.412.285-.944.285-1.594%200-.645-.095-1.172-.285-1.581a1.852%201.852%200%200%200-.84-.903c-.372-.194-.831-.29-1.376-.29h-1.176v5.565ZM52.41%2073.273V82h-1.845v-8.727h1.845Zm1.518%200h2.276l2.403%205.863h.103l2.403-5.863h2.276V82h-1.79v-5.68h-.072l-2.26%205.637H58.05l-2.258-5.659h-.073V82h-1.79v-8.727ZM66.413%2082h-1.977l3.013-8.727h2.377L72.837%2082h-1.978l-2.186-6.733h-.069L66.413%2082Zm-.123-3.43h4.67v1.44h-4.67v-1.44Zm12.972-2.476a1.914%201.914%200%200%200-.251-.55%201.7%201.7%200%200%200-.925-.669%202.232%202.232%200%200%200-.652-.09c-.446%200-.838.111-1.176.333-.335.222-.597.544-.784.967-.188.42-.281.935-.281%201.543%200%20.608.092%201.125.277%201.551.184.426.446.751.784.976.338.221.737.332%201.197.332.418%200%20.774-.074%201.07-.221.298-.15.525-.363.682-.635.159-.273.238-.596.238-.968l.375.056h-2.25v-1.39h3.652v1.1c0%20.767-.162%201.426-.486%201.977a3.31%203.31%200%200%201-1.338%201.27c-.568.296-1.218.443-1.951.443-.819%200-1.537-.18-2.157-.54a3.756%203.756%200%200%201-1.448-1.548c-.344-.67-.516-1.466-.516-2.386%200-.707.102-1.338.307-1.892a4.043%204.043%200%200%201%20.869-1.415c.372-.386.805-.68%201.3-.882a4.211%204.211%200%200%201%201.606-.303c.495%200%20.955.073%201.381.218.426.142.804.344%201.133.605.333.261.604.572.814.933.21.358.346.753.405%201.185h-1.875ZM82.604%2082v-8.727h5.88v1.521H84.45v2.08h3.733v1.52H84.45v2.085h4.053V82h-5.898Z%22%2F%3E%3C%2Fsvg%3E" %}

  {% for b in background.backgrounds|reverse %}
    {% if not b.disabled %}
      {% if b.type == 'image' %}
        {% set size = b.image_size|default("full") %}
        {% set default_img = b.image.url %}
        {% set img_url = b.image.sizes[size].url|default(default_img)|default(bg_image_placeholder) %}

        {# Dynamic images are strings #}
        {% if b.image and b.image is not iterable %}
          {% set bg_image = bg_image|merge([ b.image ]) %}
        {% elseif img_url %}
            {% set bg_image = bg_image|merge([ 'url(' ~ img_url ~ ')' ]) %}
        {% endif %}

        {% if b.background_size == 'custom' %}
          {% if b.background_size_custom.width.style and not b.background_size_custom.height.style %}
            {% set custom_size = b.background_size_custom.width.style %}
          {% elseif not b.background_size_custom.width.style and b.background_size_custom.height.style %}
            {% set custom_size = 'auto ' ~ b.background_size_custom.height.style %}
          {% elseif b.background_size_custom.width.style and b.background_size_custom.height.style %}
            {% set custom_size = b.background_size_custom.width.style ~ ' ' ~ b.background_size_custom.height.style %}
          {% else %}
            {% set custom_size = 'auto' %}
          {% endif %}

          {% set bg_size = bg_size|merge([ custom_size ]) %}
        {% else %}
          {% set bg_size = bg_size|merge([ b.background_size|default('auto') ]) %}
        {% endif %}

        {% set position_x = b.background_position.x ? b.background_position.x ~ '%' : '0' %}
        {% set position_y = b.background_position.y ? b.background_position.y ~ '%' : '0' %}
        {% set custom_position = position_x ~ ' ' ~ position_y %}

        {% set bg_position   = bg_position|merge([ custom_position ]) %}
        {% set bg_repeat     = bg_repeat|merge([ b.background_repeat|default('repeat') ]) %}
        {% set bg_attachment = bg_attachment|merge([ b.background_attachment|default('scroll') ]) %}
        background-blend-mode: {{ b.background_blend_mode }};
      {% elseif b.type == 'color_overlay' %}
        {% set color    = b.color|default('rgba(0, 0, 0, 0.5)') %}
        {% set bg_image = bg_image|merge([ 'linear-gradient(' ~ color ~ ', ' ~ color ~ ')' ]) %}
      {% elseif b.type == 'gradient' %}
        {% set gradient = b.gradient.value|default("linear-gradient(black, white)") %}

        {% if b.gradient.value %}
         {% set gradient = b.gradient.value %}
        {% elseif b.gradient is not iterable %}
          {% set gradient = b.gradient %}
        {% else %}
          {% set gradient = 'linear-gradient(black, white)' %}
        {% endif %}

        {% set bg_image = bg_image|merge([ gradient ]) %}
      {% endif %}

      {% if b.type == 'color_overlay' or b.type == 'gradient' %}
        {% set bg_size  = bg_size|merge([ 'auto' ]) %}
        {% set bg_repeat = bg_repeat|merge([ 'repeat' ]) %}
        {% set bg_position = bg_position|merge([ '0px 0px' ]) %}
        {% set bg_attachment = bg_attachment|merge([ 'scroll' ]) %}
      {% endif %}
    {% endif %}
  {% endfor %}
  background-image: {{ bg_image|join(', ') }};
  background-size: {{ bg_size|join(', ') }};
  background-position: {{ bg_position|join(', ') }};
  background-repeat: {{ bg_repeat|join(', ') }};
  background-attachment: {{ bg_attachment|join(', ') }};

  /* Borders */
  {% set radius = borders.border_radius %}
  {% if radius.editMode == "custom" %}
    border-top-left-radius: {{ radius.topLeft.style }};
    border-top-right-radius: {{ radius.topRight.style }};
    border-bottom-left-radius: {{ radius.bottomLeft.style }};
    border-bottom-right-radius: {{ radius.bottomRight.style }};
  {% else %}
    border-radius: {{ radius.all.style }};
  {% endif %}

  {% for position, border in borders.borders %}
    {% if border.width.style %}
      border-{{ position }}: {{ border.width.style }} {{ border.style|default('solid') }} {{ border.color }};
    {% endif %}
  {% endfor %}

  /* Effects */
  opacity: {{ effects.opacity is defined ? effects.opacity / 100 }};
  cursor: {{ effects.cursor }};
  mix-blend-mode: {{ effects.blend_mode }};
  pointer-events: {{ effects.pointer_events }};

  {% set transition = '' %}
  {% for item in effects.transition %}
    {% if not item.disabled %}
      {% set transition = transition ~ item.property ~ ' ' ~ item.duration.style ~ ' ' ~ item.easing %}
      {% if item.delay.style %}
        {% set transition = transition ~ ' ' ~ item.delay.style %}
      {% endif %}
      {% if not loop.last %}
          {% set transition = transition ~ ', ' %}
      {% endif %}
    {% endif %}
  {% endfor %}
  transition: {{ transition }};

  {% set boxShadow = '' %}
  {% for shadow in effects.box_shadow %}
    {% if not shadow.disabled %}
      {% set inset = shadow.position == 'inset' ? 'inset ' : '' %}
      {% set boxShadow = boxShadow ~ ' ' ~ inset ~ shadow.x.style ~ ' ' ~ shadow.y.style ~ ' ' ~ shadow.blur.style ~ ' ' ~ shadow.spread.style ~ ' ' ~ shadow.color %}
      {% if not loop.last %}
          {% set boxShadow = boxShadow ~ ', ' %}
      {% endif %}
    {% endif %}
  {% endfor %}
  box-shadow: {{ boxShadow }};

  filter:
    {% for f in effects.filter %}
      {% if not f.disabled %}
        {% if f.type == 'blur' %}
          blur({{ f.blur_value.style }})
        {% elseif f.type == 'hue-rotate' %}
          hue-rotate({{ f.hue_value.style }})
        {% elseif f.type %}
          {{ f.type }}({{ f.value.style }})
        {% endif %}
      {% endif %}
    {% endfor %};

  backdrop-filter:
    {% for f in effects.backdrop_filter %}
      {% if not f.disabled %}
        {% if f.type == 'blur' %}
          blur({{ f.blur_value.style }})
        {% elseif f.type == 'hue-rotate' %}
          hue-rotate({{ f.hue_value.style }})
        {% elseif f.type %}
          {{ f.type }}({{ f.value.style }})
        {% endif %}
      {% endif %}
    {% endfor %};

    -webkit-backdrop-filter:
    {% for f in effects.backdrop_filter %}
      {% if not f.disabled %}
        {% if f.type == 'blur' %}
          blur({{ f.blur_value.style }})
        {% elseif f.type == 'hue-rotate' %}
          hue-rotate({{ f.hue_value.style }})
        {% elseif f.type %}
          {{ f.type }}({{ f.value.style }})
        {% endif %}
      {% endif %}
    {% endfor %};

  transform:
    {% for t in effects.transform %}
      {% if not t.disabled %}
        {% if t.type == 'translate' %}
          translate3d({{ t.translate_x.style|default(0) }}, {{ t.translate_y.style|default(0) }}, {{ t.translate_z.style|default(0) }})
        {% elseif t.type == 'scale' %}
          scale({{ t.scale_x|default(0) }}, {{ t.scale_y|default(0) }})
        {% elseif t.type == 'rotate' %}
          {% if t.rotate_x %}
            rotateX({{ t.rotate_x.style }})
          {% endif %}

          {% if t.rotate_y %}
            rotateY({{ t.rotate_y.style }})
          {% endif %}

          {% if t.rotate_z %}
            rotateZ({{ t.rotate_z.style }})
          {% endif %}
        {% elseif t.type == 'skew' %}
          skew({{ t.skew_x.style|default(0) }}, {{ t.skew_y.style|default(0) }})
        {% endif %}
      {% endif %}
    {% endfor %};
{% endmacro %}

{% set name = selector.type == 'class' ? '.' ~ selector.name : selector.name %}

{{ name }} {
  {{ self.css_properties(selector.properties) }}
}

{% for nestedSelector in selector.children %}
  {{ nestedSelector.name }} {
    {{ self.css_properties(nestedSelector.properties) }}
  }

  {{ nestedSelector.properties.custom_css.custom_css|replace({ ':selector': nestedSelector.name }) }}
{% endfor %}

{{ selector.properties.custom_css.custom_css|replace({ ':selector': name }) }}
